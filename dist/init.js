"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,o=Array(e.length);t<e.length;t++)o[t]=e[t];return o}return Array.from(e)}Array.prototype.isEqual=function(e){return JSON.stringify(this)===JSON.stringify(e)},Array.prototype.sumWith=function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];for(var t=[this].concat(_toConsumableArray(t)).sort(function(e,t){return t.length-e.length}),r=[].concat(_toConsumableArray(t[0])),n=1,i=t.length;n<i;n++)for(var a=t[n],s=0,l=a.length;s<l;s++){var u=a[s];r[s]+=u}return r},Array.prototype.sumAll=function(){return this.reduce(function(e,t){return e+t},0)},Array.prototype.lastItem=function(){return this[this.length-1]},Array.prototype.includesArr=function(e){for(var t=this.length-1;0<=t;t--)if(this[t].isEqual(e))return!0},Array.prototype.shuffle=function(){for(var e=[],t=0,o=this.length;t<o;t++)e.push(this.splice(Math.floor(Math.random()*this.length),1)[0]);return e.push(this[0]),e},Array.prototype.clear=function(){this.length=0},Number.prototype.isEqual=function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];for(var r=0,n=t.length;r<n;r++)if(this==t[r])return!0;return!1},Object.prototype.merge=function(e){for(var t in e)this[t]=e[t]};var electron=require("electron"),events=require("events"),express=require("express"),app=express(),internalIp=require("internal-ip"),server=app.listen(5300),powerups=(app.use(express.static("dist/static/")),electron.app.on("ready",function(){var e=new electron.BrowserWindow({minWidth:800,minHeight:480,width:1024,height:720,icon:__dirname+"/icons/64x64.ico"});e.webContents.openDevTools(),app.use(express.static("static")),e.loadURL("http://localhost:"+server.address().port)}),electron.app.on("window-all-closed",function(){electron.app.quit()}),new function(){var o=this,i={};this.on=function(e,t){var n;i[e]||(i[e]=[]),i[e].push(t),o[e]=(n=e,function(e,t){for(var o=0,r=i[n].length;o<r;o++)i[n][o](e,t)})}});function Engine(){var i=[],a={};this.run=function(){var n=Date.now();setInterval(function(){for(var e=Date.now(),t=(e-n)/1e3,o=(1<=(t=Math.min(1,t))&&(n=e),t),r=i.length;r--;)"function"==typeof i[r].update&&i[r].update(o);Object.keys(a).length&&(io.emit("update",a),a={})},0)},this.add=function(e){return i.push(e)},this.sendUpdate=function(e,t,o){a[e]||(a[e]=[]),a[e][t]||(a[e][t]={}),a[e][t]=Object.assign(a[e][t],o)},this.clear=function(){return i=[]}}function Food(t,e){var o,r=this,n=(this.id=e,[]);for(o in this.type,this.position=[],t.engine.add(this),gameProps.foods.types)for(var i=gameProps.foods.types[o],a=i.chance,s=0;s<a;s++)n.push(i);this.senUpdate=function(e){return t.engine.sendUpdate("foods",r.id,e)},this.create=function(){var e=Math.round(Math.random()*(n.length-1));this.type=n[e],this.position=[[],[]].map(function(e,t){return Math.round(Math.random()*(gameProps.tiles[t]-1))}),this.senUpdate({position:this.position,color:this.type.color})},this.create()}function Game(){var e,o=this,t="toStart";Object.defineProperties(this,{playersInTheRoom:{value:[],writable:!1},players:{value:[],writable:!1},foods:{value:[],writable:!1},roomCreator:{writable:!0},multiplayerLocalAllow:{value:!1,writable:!0},readyPlayers:{value:0,writable:!0},colorsInUse:{get:function(){var t=[];return o.for("playersInTheRoom",function(e){return t.push(e.color)}),t}},winner:{get:function(){var t;return o.for("players",function(e){e.killed||(t=e)}),t}},status:{get:function(){return t},set:function(e){"over"==e&&(o.multiplayerLocalAllow||(game.playersInTheRoom.length=1),io.emit("game over",o.winner),o.clear(),o.gameRules.close(),o.clear()),t=e}},gameRules:{value:{get take(){return e},init:function(){return e=new GameRules(o)},close:function(){return e=void 0}},writable:!1}}),Object.defineProperty(this,"engine",{value:new Engine(this),writable:!1}),this.engine.run()}function GameRules(a){a.engine.add(this),this.deathCounter=0;this.update=function(){"playing"==a.status&&(a.for("players",function(r,n){if(!r.killed){for(var i=r.head,e=r.body.length-1;0<=e;e--)if(0<e&&r.body[e].isEqual(i))return r.collided=!0;r.collided||a.for("players",function(e,t){if(n!=t&&!e.killed)for(var o=e.body.length-1;0<=o;o--)if(e.body[o].isEqual(i))return r.collided=!0})}}),a.for("players",function(e){e&&!e.killed&&(e.killed=e.collided)}),a.for("foods",function(o){a.for("players",function(e){var t;e.head.isEqual(o.position)&&(e.increase++,(t=o.type.powerup||null)&&powerups[t]&&(powerups[t](e,a),io.emit("show powerup",t)),o.create(),a.event.emit("foodEated",o.id))})}))}}function Snake(o,e){var d=this,n=(this.id=null,this.enhancerId=null,this.body=[],this.increase=0,this.superSpeed=0,this.superSlow=0,this.freeze=0,this.collided=!1,this.bodyStart=[0,0],this.AI=!1,this.merge(e),this.directionMap={left:[-1,0],right:[1,0],up:[0,-1],down:[0,1],"-1":"left",1:"right","-2":"up",2:"down"},gameProps.snakes.initialDirection),t=(Object.defineProperty(this,"direction",{get:function(){return n},set:function(e){var t=Object.keys(d.directionMap),o=n,r=gameProps.snakes.reverse;t.includes(e)&&(n=e),a().isEqual(d.body[1])&&(r?(n=d.tailDirection,d.body.reverse()):n=o)}}),Object.defineProperties(this,{head:{get:function(){return d.body[0]}},tail:{get:function(){return d.body[d.body.length-1]}},tailDirection:{get:function(){var e=d.body[d.body.length-2],t=d.tail;return t[0]>e[0]?"right":t[0]<e[0]?"left":t[1]>e[1]?"down":t[1]<e[1]?"up":void 0}}}),!1),r=(Object.defineProperty(this,"killed",{get:function(){return t},set:function(e){e!=t&&(t=!!e,d.senUpdate({killed:t}),t&&o.gameRules.take.deathCounter++,o.gameRules.take.deathCounter>=o.players.length-1)&&(o.status="over")}}),Object.defineProperty(this,"bodyVertices",{get:function(){for(var o,r=[[d.body[0]]],n=d.body[0],e=1,t=d.body.length;e<t;e++){var i=d.body[e];i.map(function(e,t){e==n[t]&&(o?o!=t&&(r.push([]),o=t):o=t)}),r.lastItem().push(i),n=i}return r}}),Object.defineProperty(this,"verticesDirections",{get:function(){for(var e=d.head,t=d.bodyVertices,o=[],r=1,n=t.length;r<n;r++){var i=t[r];e:for(var a=0,s=i.length;a<s;a++)for(var l=i[a],u=0,c=l.length;u<c;u++)if(e[u]==l[u]){var p=Math.abs(u-1);e[p]<l[p]?o.push(d.directionMap[+(p+1)]):o.push(d.directionMap[-1*(p+1)]);break e}}return o}}),this.senUpdate=function(e){return o.engine.sendUpdate("players",d.enhancerId,e)},o.engine.add(this),new SnakeControls(this,o)),i=(this.newBody(),this.AI&&(this.AI=new snakeAI(o,this)),0),a=function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,o=d.directionMap[d.direction],r=Math.abs(o[1]);return(e=[].concat(_toConsumableArray(d.body[0])))[r]+=o[r]*t,e[r]>=gameProps.tiles[r]?e[r]=0:e[r]<0&&(e[r]=gameProps.tiles[r]-1),e};this.update=function(e){var t;d.body.length&&!d.killed&&(e=e,"playing"!=o.status||(t=gameProps.snakes.speed,0<d.superSpeed&&(t*=1.4),0<d.superSlow&&(t*=.5),~~(e=e*t)<=~~(i=e<i?0:i))||(d.AI?d.AI.movement():r.currentMovement(),i=t<=e?0:e,d.freeze<=0&&(d.body.splice(0,0,a()),d.increase<1?d.body.pop():d.increase--),d.superSpeed&&d.superSpeed--,d.superSlow&&d.superSlow--,d.freeze&&d.freeze--,d.senUpdate({body:d.body})))}}function SnakeControls(t,e){var o=[];e.event.on("moveTo",function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{id:id,moveTo:moveTo};e.id==t.id&&e.moveTo!=o.lastItem()&&o.push(e.moveTo)}),this.currentMovement=function(){(o=o.filter(Boolean)).length&&(t.direction=o[0],o)&&o.splice(0,1)}}powerups.on("freeze",function(t,e){e.for("players",function(e){e.enhancerId!=t.enhancerId&&(e.freeze+=10)})}),powerups.on("super increase",function(e){return e.increase+=5}),powerups.on("super slow",function(t,e){e.for("players",function(e){e.enhancerId!=t.enhancerId&&(e.superSlow+=50)})}),powerups.on("super speed",function(e){return e.superSpeed+=50}),Game.prototype.event=new events.EventEmitter,Game.prototype.clear=function(){this.players.clear(),this.foods.clear(),this.readyPlayers=0,this.engine.clear()},Game.prototype.start=function(){function e(){io.emit("countdown",o),o--}var t=this,o=(this.gameRules.init(),this.addFoods(),this.addPlayers(),3),r=(e(),setInterval(function(){if(o<1)return t.status="playing",clearInterval(r);e()},1e3))},Game.prototype.for=function(e,t){if("object"==(void 0===e?"undefined":_typeof(e)))for(var o=0,r=e.length;o<r&&0!=t(e[o],o);o++);else for(var n=0,i=this[e].length;n<i&&0!=t(this[e][n],n);n++);},Game.prototype.addPlayers=function(){var t=this;this.for("playersInTheRoom",function(e){return t.players.push(new Snake(t,e))})},Game.prototype.addFoods=function(){for(var e=0;e<gameProps.foods.qnt;e++){var t=new Food(this,this.foods.length);this.foods.push(t)}},Game.prototype.generateColor=function(){var e=Math.round(Math.random()*(gameProps.snakes.colors.length-1));return this.colorsInUse.includes(e)?this.generateColor():e},Game.prototype.createPlayers=function(e){for(var t=[],o=0;o<e;o++){var r={id:"comp-"+o,enhancerId:this.playersInTheRoom.length,AI:!0,nickname:"Computer "+(o+1),bodyStart:newBodyStart(this.playersInTheRoom.length),color:this.generateColor()};this.playersInTheRoom.push(r),t.push(r)}return io.emit("teste",this.playersInTheRoom),t};var gameProps={tiles:[64,36],snakes:{speed:15,initialSize:1,initialDirection:"right",reverse:!(Snake.prototype.newBody=function(){for(var e=this.bodyStart,t=[e[0],e[1]],o=e[2],r=(this.body=[t],gameProps.snakes.initialSize),n=1;n<r;n++){this.body.push([]);var i=[].concat(t);switch(o){case"right":case"left":i[0]="right"==o?t[0]+n:t[0]-n;break;case"up":case"down":i[1]="down"==o?t[1]+n:t[1]-n}for(var a=0;a<=1;a++)i[a]<0&&(i[a]=gameProps.tiles[a]-Math.abs(i[a])),i[a]>=gameProps.tiles[a]&&(i[a]=i[a]-gameProps.tiles[a]),this.body[n].push(i[a])}this.senUpdate({body:this.body})}),sensibilityTouch:30,keyMaps:[{left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown"},{left:"a",right:"d",up:"w",down:"s"}],colors:["#000000","DimGray","HotPink","Brown","DarkBlue","RosyBrown","Chocolate","AliceBlue","Goldenrod"]},foods:{qnt:1,types:{normal:{chance:30,color:"#FFE400"},superSlow:{chance:3,color:"#af3907",powerup:"super slow"},superSpeed:{chance:3,color:"#0f8660",powerup:"super speed"},superIncrease:{chance:3,color:"#29002d",powerup:"super increase"},freeze:{chance:0,color:"#076f96",powerup:"freeze"},invisible:{chance:0,color:"#a607af"}}}},newBodyStart=function(e){e++;var t=Math.round(e/3.0001%1*3),e=Math.ceil(e/3);return io.emit("teste",t),[16*t,9*e,"down"]};function snakeAI(c,p){function t(){var e=c.foods;return e[Math.round(Math.random()*(e.length-1))]}var d,h=t(),f=(c.event.on("foodEated",function(e){h.id==e&&(h=t(),d=void 0)}),function(){var i=[],o=p.enhancerId,a=p.head;return c.for("players",function(e,t){return e.killed||o==t?null:c.for(e.body,function(n){return c.for(n,function(e,t){var o,r=1==t?0:1;n[t].isEqual(a[t])&&(t=a[r]-n[r],(o=Math.abs(t))<=5)&&i.push(p.directionMap[-(t/o)*(1+r)])})})}),i.concat(p.verticesDirections)}),m=function(e){return"left"==e||"right"==e?"horizontal":"vertical"};this.movement=function(){null==d&&(d=Math.round(Math.random()));o=["left","right","up","down"],r=p.direction,l=p.verticesDirections,u=f(),c.for(o,function(e,t){if(!u.includes(e)&&!l.includes(e)){if(m(e)!=m(r))return;if(r==e)return}o[t]=null}),n=o,i=[],a=p.head,s=h.position,c.for(s,function(e,t){var o=t,r=(s[t]>a[t]&&o++,n.splice(o,1)[0]);d==t&&t!=o&&(t<o?1==o?"left"==p.direction&&(d=1):2==o&&"up"==p.direction&&(d=0):0==o?"right"==p.direction&&(d=1):1==o&&"down"==p.direction&&(d=1)),t==d&&s[t]!=a[t]&&i.push(r),t!=d&&s[d]==a[d]&&i.push(r)});var n,i,a,s,o,r,l,u,e=i.concat(n.shuffle()).filter(Boolean);p.direction=e[0]}}var game=new Game,io=require("socket.io")(server);io.on("connection",function(r){game.roomCreator||(game.roomCreator=r.id),r.on("disconnect",function(){r.id==game.roomCreator&&(game.status="toStart",game.roomCreator=void 0,game.playersInTheRoom.length=0,game.clear(),io.emit("multiplayer-local deny"))}),r.on("login",function(e){var t,o;return game.roomCreator==r.id||game.multiplayerLocalAllow?"playing"==game.status?r.emit("is playing"):(t=game.playersInTheRoom.length,o={id:r.id,enhancerId:t,nickname:e.playerNickname,bodyStart:newBodyStart(game.playersInTheRoom.length)},r.emit("logged",{myID:o.id,multiplayerLocal:game.multiplayerLocalAllow,player:o,playersInTheRoom:game.playersInTheRoom,gameProps:gameProps}),game.playersInTheRoom.push(o),r.broadcast.emit("new player",o),r.on("disconnect",function(){r.id!=game.roomCreator&&(game.readyPlayers=0,game.playersInTheRoom.splice(t,1),io.emit("delete player",t),"playing"==game.status)&&(game.players[t].killed=!0)}),r.on("change color",function(e){if(game.colorsInUse.includes(e))return r.emit("color in use");r.emit("color not in use"),0<=e&&e<gameProps.snakes.colors.length&&(o.color=e,io.emit("playersInTheRoom update",{i:t,color:e}))}),r.on("start",function(){game.playersInTheRoom.length&&!game.multiplayerLocalAllow&&game.roomCreator!=r.id||(io.emit("start"),game.start())}),r.on("moveTo",function(e){return game.event.emit("moveTo",e)}),r.on("prepare single-player",function(e){game.playersInTheRoom.length&&game.multiplayerLocalAllow||io.emit("prepare game",game.createPlayers(e))}),r.on("prepare multiplayer",function(e){if(!game.playersInTheRoom.length||!game.multiplayerLocalAllow){if(game.colorsInUse.includes(e.color))return r.emit("color in use");var t=[],o={id:r.id+"[1]",idLocal:1,enhancerId:game.playersInTheRoom.length,nickname:e.nickname||"Player 2",bodyStart:newBodyStart(game.playersInTheRoom.length),color:e.color};game.playersInTheRoom.push(o),t.push(o),t=[].concat(_toConsumableArray(t),_toConsumableArray(game.createPlayers(e.nPlayers))),io.emit("prepare game",t)}}),r.on("multiplayer-local allow",function(){game.roomCreator==r.id&&(game.multiplayerLocalAllow=!0,game.readyPlayers=0,r.on("disconnect",function(){return game.multiplayerLocalAllow=!1}),r.emit("multiplayer-local address",internalIp.v4.sync()+":"+server.address().port))}),r.on("multiplayer-local deny",function(){game.roomCreator==r.id&&(game.multiplayerLocalAllow=!1,r.broadcast.emit("multiplayer-local deny"))}),r.on("ready",function(){io.emit("teste",game.playersInTheRoom),game.readyPlayers<0&&(game.readyPlayers=0),game.readyPlayers++,game.readyPlayers==game.playersInTheRoom.length&&1<game.playersInTheRoom.length&&(io.emit("start"),game.start()),r.on("disconnect",function(){return game.readyPlayers--})}),void r.on("logout",function(){return r.disconnect()})):r.emit("multiplayer disabled")})});