"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function Engine(t){var o=this,n=t.ctx.canvas,r=[];this.draw=function(){t.ctx.clearRect(0,0,n.width,n.height);for(var e=r.length;e--;)"function"==typeof r[e].draw&&r[e].draw()},this.add=function(n){r.push(n),n.update=function(e){for(var t in e)n[t]=e[t];requestAnimationFrame(o.draw)}},this.clear=function(){return r=[]}}function Food(e,t){var n=this;this.id=t,this.color;var o=[];this.position=[],e.engine.add(this),this.draw=function(){n.position.isEqual(o)||(e.sounds.ate.play,o=[].concat(_toConsumableArray(n.position))),n.color&&(e.ctx.fillStyle=n.color,e.ctx.beginPath(),e.ctx.arc(n.position[0]*e.tileSize+e.tileSize/2,n.position[1]*e.tileSize+e.tileSize/2,e.tileSize/2,0,2*Math.PI),e.ctx.closePath(),e.ctx.fill())}}function Game(t){var n,o,r=this,i=t.parentNode,a="true"==localStorage.getItem("mute");Object.defineProperties(this,{id:{writable:!0},time:{value:0,writable:!0},winner:{writable:!0},playersInTheRoom:{value:[],writable:!1},players:{value:[],writable:!1},foods:{value:[],writable:!1},multiplayerLocalAllow:{value:!1,writable:!0},socket:{value:io(),writable:!1},tileSize:{set:function(e){n=Math.floor(+e),t.width=r.tileSize*gameProps.tiles[0],t.height=r.tileSize*gameProps.tiles[1],t.style.backgroundSize=r.tileSize+"px "+r.tileSize+"px"},get:function(){return n}},ctx:{value:t.getContext("2d"),writable:!1},status:{set:function(e){"game-over"==e&&r.sounds.gameOver.play,i.className=o=e},get:function(){return o}},colorsInUse:{get:function(){var t=[];return r.for("playersInTheRoom",function(e){return t.push(e.color)}),t}},mute:{set:function(e){a=!!e,localStorage.setItem("mute",a),r.interface.audioToggle(a)},get:function(){return a}}}),Object.defineProperties(this,{engine:{value:new Engine(this),writable:!1},interface:{value:new Interface(this),writable:!1},sounds:{value:new Sounds(this),writable:!1}}),this.socket.on("is playing",function(){return r.interface.dialogBox.alert("Danied","The game is already happening. Try again later.")}),this.socket.on("teste",function(e){return console.log(e)}),this.interface.audioToggle(a),gestureViewer(this)}function Snake(t,e){var n=this;this.id=null,this.idLocal=null,this.enhancerId=null,this.nickname=null,this.body=[],this.color=0;var o=!1;Object.defineProperty(this,"killed",{get:function(){return o},set:function(e){(o=e)&&(t.sounds.died.play,t.interface.listPlayersInGame())}}),this.merge(e),0==this.idLocal&&(this.touchArea="all"),1==this.idLocal&&(t.players[0].touchArea="right",this.touchArea="left"),t.engine.add(this),isNaN(this.idLocal)||new SnakeControls(this,t),this.draw=function(){n.killed||(t.ctx.fillStyle=gameProps.snakes.colors[n.color],n.body.forEach(function(e){t.ctx.fillRect(e[0]*t.tileSize,e[1]*t.tileSize,t.tileSize,t.tileSize)}))}}function Sounds(s){var l=this,c=s.ctx.canvas,u={menu:"menu.wav",back:"back.wav",prev:"prev.wav",next:"next.wav",died:"died.wav",ate:"ate.wav",enter:"enter.wav",gameOver:"game-over.wav"};!function(){for(var a=Object.keys(u),e=function(e,t){var n=a[e],o=u[n],r=o.split(".").lastItem(),i=document.createElement("audio");i.className="sound",i.src="sounds/"+o,i.setAttribute("type","audio/"+("mp3"==r?"mpeg":r)),c.parentNode.insertBefore(i,c),l[n]={},Object.defineProperties(l[n],{play:{get:function(){s.mute||i.play()}},volume:{get:function(){return i.volume},set:function(e){return i.volume=e}}})},t=0,n=a.length;t<n;t++)e(t)}()}Array.prototype.isEqual=function(e){return JSON.stringify(this)===JSON.stringify(e)},Array.prototype.sumWith=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];t=[this].concat(_toConsumableArray(t)).sort(function(e,t){return t.length-e.length});for(var o=[].concat(_toConsumableArray(t[0])),r=1,i=t.length;r<i;r++)for(var a=t[r],s=0,l=a.length;s<l;s++){var c=a[s];o[s]+=c}return o},Array.prototype.sumAll=function(){return this.reduce(function(e,t){return e+t},0)},Array.prototype.lastItem=function(){return this[this.length-1]},Array.prototype.includesArr=function(e){for(var t=this.length-1;0<=t;t--)if(this[t].isEqual(e))return!0},Array.prototype.shuffle=function(){for(var e=[],t=0,n=this.length;t<n;t++)e.push(this.splice(Math.floor(Math.random()*this.length),1)[0]);return e.push(this[0]),e},Array.prototype.clear=function(){this.length=0},Number.prototype.isEqual=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var o=0,r=t.length;o<r;o++)if(this==t[o])return!0;return!1},Object.prototype.merge=function(e){for(var t in e)this[t]=e[t]},Game.prototype.start=function(){this.interface.hideModal(),this.clear(),this.addPlayers(),this.addFoods(),this.status="playing"},Game.prototype.clear=function(){this.players.clear(),this.foods.clear(),this.winner=null,this.engine.clear()},Game.prototype.for=function(e,t){if("object"==(void 0===e?"undefined":_typeof(e)))for(var n=0,o=e.length;n<o&&0!=t(e[n],n);n++);else for(var r=0,i=this[e].length;r<i&&0!=t(this[e][r],r);r++);},Game.prototype.addPlayers=function(){for(var e=this.playersInTheRoom.length,t=0;t<e;t++){var n=new Snake(this,this.playersInTheRoom[t]);this.players.push(n)}},Game.prototype.addFoods=function(){this.foods.push(new Food(this,this.foods.length)),this.foods.length<gameProps.foods.qnt&&this.addFoods()},Game.prototype.resizeCanvas=function(){var t=this,o=document.querySelectorAll(".snake-chooser .snake"),e=function(){var n=[window.innerWidth,window.innerHeight],e=[0,0].map(function(e,t){return n[t]/gameProps.tiles[t]});t.tileSize=e[e[0]>e[1]?1:0],function(){for(var e=o.length-1;0<=e;e--)o[e].style.width=t.tileSize+"px",o[e].style.height=t.tileSize+"px"}()};e(),window.addEventListener("resize",e)},Game.prototype.login=function(e,n){var o=this;this.socket.emit("login",{playerNickname:e}),this.socket.on("logged",function(e){var t;gameProps=Object.assign(gameProps,e.gameProps),e.player.idLocal=0,o.multiplayerLocalAllow=e.multiplayerLocal,o.id=e.myID,(t=o.playersInTheRoom).push.apply(t,_toConsumableArray(e.playersInTheRoom).concat([e.player])),o.resizeCanvas(),o.socketEvents(),"function"==typeof n&&n(e)}),this.socket.on("multiplayer disabled",function(){o.socket.off("login"),o.socket.off("logged"),o.socket.off("multiplayer disabled"),o.interface.dialogBox.alert("Danied","Local multiplayer disabled.")})},Game.prototype.socketEvents=function(){var r=this;this.socket.on("start",function(){r.start(),r.interface.listPlayersInGame()}),game.socket.on("game over",function(e){r.winner=e,r.status="game-over",r.interface.gameOver()}),this.socket.on("new player",function(e){r.playersInTheRoom.push(e),r.interface.listPlayersInTheRoom()}),this.socket.on("color in use",function(){return r.interface.dialogBox.alert("Denied","This color is being used.")}),this.socket.on("prepare game",function(e){var t;(t=r.playersInTheRoom).push.apply(t,_toConsumableArray(e)),r.socket.emit("start")}),this.socket.on("playersInTheRoom update",function(e){var t=e.i;delete e.i,r.playersInTheRoom[t].merge(e),game.interface.listPlayersInTheRoom()}),this.socket.on("delete player",function(e){r.playersInTheRoom.splice(e,1),r.interface.listPlayersInTheRoom()}),this.socket.on("update",function(e){r.for(Object.keys(e),function(o){r.for(e[o],function(t,n){t&&r.for(Object.keys(t),function(e){return r[o][n][e]=t[e]})}),r.engine.draw()})}),this.socket.on("multiplayer-local address",this.interface.openMultiplayerLocal),this.socket.on("multiplayer-local deny",function(){r.playersInTheRoom.clear(),r.clear(),r.interface.show("login"),r.socket.emit("logout"),r.interface.dialogBox.alert("Danied","Local multiplayer disabled.",function(){return location.reload()})})};var gameProps={};function gestureViewer(a){var e=document.querySelector("#gestureViewer"),o=document.createElement("canvas"),r=o.getContext("2d");e.appendChild(o);var s={},l=0,c=function(e,t,n,o){r.strokeStyle="#7da278",r.lineCap="round",r.lineWidth=8,r.beginPath(),r.moveTo(e,t),r.lineTo(n,o),r.stroke()};window.addEventListener("touchstart",function(e){if("playing"==a.status)for(var t=e.changedTouches.length-1;0<=t;t--){var n=e.changedTouches[t],o={x:n.pageX,y:n.pageY};s[n.identifier||++l]=o,c(o.x-1,o.y,o.x,o.y)}}),window.addEventListener("touchmove",function(e){if("playing"==a.status)for(var t=e.changedTouches.length-1;0<=t;t--){var n=e.changedTouches[t],o=s[n.identifier||l],r=n.pageX,i=n.pageY;c(o.x,o.y,r,i),o.x=r,o.y=i}}),window.addEventListener("touchend",function(e){if("playing"==a.status){for(var t=e.changedTouches.length-1;0<=t;t--){var n=e.changedTouches[t];delete s[n.identifier||l]}setTimeout(function(){return r.clearRect(0,0,o.width,o.height)},200)}}),document.ontouchmove=function(e){e.preventDefault()};var t=function(){o.width=window.innerWidth,o.height=window.innerHeight};t(),window.addEventListener("resize",t)}function Interface(n){var o=this,e=function(e,t){var n;return 1<(n=t?e.querySelectorAll(t):document.querySelectorAll(e)).length?n:n[0]},t=e("#interface"),r=e(t,".modal"),i=e(t,"#login form"),a=e(i,'[name="player_name"]'),s=e("#after-login .submit"),l=e(t,"#main-menu"),c=e(l,"#welcome"),u=e(l,"#single-player"),d=e(l,"#multiplayer"),h=e(l,"#multiplayer-local"),f=e(l,"#tutorial"),m=e(t,"#single-player-menu"),p=e(m,".submit"),y=e(m,".input-number"),g=e(m,".back"),v=e(t,"#multiplayer-menu"),k=e(v,".submit"),w=e(v,'[name="player_name"]'),b=e(v,".input-number"),S=e(v,".back"),L=e(t,"#multiplayer-local-menu"),T=e(t,".connected-players ul"),A=e(L,".submit"),x=e(L,".player-counter span"),E=e(L,".address"),I=e(L,".back"),P=e("#tutorial-screen"),C=e(P,".back"),O=e(t,"#game-over"),R=e(O,"h2 span"),q=e(O,".submit"),z=e(t,"#name-of-players ul"),M=e("#audio-toggle"),N=e(t,"#label"),j=function(e){return gameProps.snakes.colors[e]};this.dialogBox=new DialogBox(t);var G=new SnakeChooser(t);new InputNumber,localStorage.getItem("lastNickname")&&(a.value=localStorage.getItem("lastNickname")),a.focus(),this.showModal=function(){return r.classList.remove("closed")},this.hideModal=function(){return r.classList.add("closed")},this.show=function(e){return t.className=e},this.listPlayersInTheRoom=function(){var t="";n.for("playersInTheRoom",function(e){t+='<li>\n                        <span\n                            style="color: '+j(e.color)+';">\n                            '+e.nickname+'\n                        </span>\n                        <div class="snake"\n                            style="background: '+j(e.color)+";\n                            width: "+n.tileSize+"px; height: "+n.tileSize+'px;">\n                        </div>\n                    </li>'}),T.innerHTML=t,x.innerText=n.playersInTheRoom.length},this.listPlayersInGame=function(){var t="";n.for("players",function(e){return t+='<li class="'+(e.killed?"dead":"")+'" style="color: '+j(e.color)+';">'+e.nickname+"</li>"}),z.innerHTML=t},this.gameOver=function(){R.style.color=n.winner?j(n.winner.color):"inherit",R.innerText=n.winner?n.winner.nickname:"Nobody",o.show("game-over")};var B=function(e,t){q.onclick=function(){n.status="toStart",n.clear(),o.showModal(),o.show(e),n.sounds.menu.play,"function"==typeof t&&t()}};i.addEventListener("submit",function(e){n.login(a.value,function(e){c.innerHTML="Hi, "+a.value,G.changeSnakeColor(),o.show("after-login"),localStorage.setItem("lastNickname",a.value),n.sounds.enter.play})}),u.addEventListener("click",function(e){return o.show("single-player-menu")}),p.addEventListener("click",function(){n.socket.emit("prepare single-player",y.getAttribute("data-value")),B("single-player-menu",function(){return n.playersInTheRoom.length=1})}),g.addEventListener("click",function(){return o.show("main-menu")}),d.addEventListener("click",function(){G.currentColor=0,G.changeSnakeColor(),o.show("multiplayer-menu")}),k.addEventListener("click",function(){n.playersInTheRoom=[n.playersInTheRoom[0]],n.socket.emit("prepare multiplayer",{nickname:w.value,color:G.currentColor,nPlayers:b.getAttribute("data-value")}),B("multiplayer-menu",function(){return n.playersInTheRoom.length=1})}),S.addEventListener("click",function(){return o.show("main-menu")}),h.addEventListener("click",function(){n.multiplayerLocalAllow=!0,n.socket.emit("multiplayer-local allow"),A.removeAttribute("disabled")}),this.openMultiplayerLocal=function(e){E.innerText=e,o.show("multiplayer-local-menu")},n.socket.on("delete player",function(){return A.removeAttribute("disabled")}),A.addEventListener("click",function(){A.setAttribute("disabled",!0),n.socket.emit("ready"),B("multiplayer-local-menu",function(){return A.removeAttribute("disabled")})}),I.addEventListener("click",function(){n.playersInTheRoom.length=1,n.socket.emit("multiplayer-local deny"),o.show("main-menu")}),f.addEventListener("click",function(){return o.show("tutorial-screen")}),C.addEventListener("click",function(){return o.show("main-menu")}),s.addEventListener("click",function(){n.socket.emit("change color",G.currentColor),n.socket.on("color not in use",function(){n.socket.off("color not in use"),n.multiplayerLocalAllow?(o.listPlayersInTheRoom(),L.className="multiplayer-local-viewer",e(L,"h4").innerText="Waiting to play ...",o.show("multiplayer-local-menu")):o.show("main-menu")})}),this.audioToggle=function(e){return M.className=e?"muted":""},M.addEventListener("click",function(){return n.mute=!n.mute}),[u,d,h,s].map(function(e){return e.addEventListener("click",function(){return n.sounds.menu.play})}),[g,S,I].map(function(e){return e.addEventListener("click",function(){return n.sounds.back.play})}),[p,k,A].map(function(e){return e.addEventListener("click",function(){return n.sounds.enter.play})}),this.label=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1e3,o=document.createElement(0==t?"span":"strong");o.innerText=e,N.innerHTML="",N.appendChild(o),setTimeout(function(){return o.className="show"},0),setTimeout(function(){return o.remove()},n)},n.socket.on("countdown",function(e){return o.label(e,1)}),n.socket.on("show powerup",function(e){return o.label(e,0,500)})}function SnakeControls(i,t){var n,a=function(e){e&&t.socket.emit("moveTo",{id:i.id,moveTo:e})},e=document.querySelector("#touch-areas"),o={left:e.querySelector("#left"),right:e.querySelector("#right")},r=(n=gameProps.snakes.keyMaps[i.idLocal])?{directions:Object.keys(n),keys:Object.keys(n).map(function(e){return n[e]}),direction:function(e){return this.directions[this.keys.indexOf(e)]}}:void 0;r&&window.addEventListener("keydown",function(e){return a(r.direction(e.key))});var s={},l={},c=gameProps.snakes.sensibilityTouch,u=[["left","right"],["up","down"]],d={0:"portrait-primary",180:"portrait-secondary",90:"landscape-primary","-90":"landscape-secondary"},h=function(){return screen.msOrientation||(screen.orientation||screen.mozOrientation||{}).type||d[window.orientation]},f=h();window.addEventListener("orientationchange",function(){return f=h()});var m=function(e){return[e.changedTouches[0].pageX,e.changedTouches[0].pageY]};if(i.touchArea)for(var p=Object.keys(o),y=function(e){var t=p[e];o[t].addEventListener("touchstart",function(e){return s[t]=m(e)}),o[t].addEventListener("touchmove",function(e){return e.preventDefault(),l[t]=m(e),function(n){var e=[[],[]].map(function(e,t){return s[n][t]-l[n][t]});if(isLumia&&("landscape-primary"===f?e[0]=-e[0]:"landscape-secondary"===f&&(e[1]=-e[1]),-1<f.indexOf("landscape")&&e.reverse(),"portrait-secondary"===f&&(e[0]=-e[0],e[1]=-e[1])),n==i.touchArea||"all"==i.touchArea){var t=+(Math.abs(e[0])<Math.abs(e[1])),o=+(e[t]<0),r=u[t][o];Math.abs(e[t])>=c&&(r!=i.direction&&a(r),s[n]=[].concat(_toConsumableArray(l[n])))}}(t),!1},{passive:!1})},g=p.length-1;0<=g;g--)y(g)}function DialogBox(a){this.alert=function(e,t,n){var o=a.querySelector(".modal"),r=document.createElement("div");r.classList.add("dialog-box","alert"),r.innerHTML="<h1>"+e+"</h1>\n                           <p>"+t+"</p>\n                           <button>Ok</button>";var i=r.querySelector("button");a.insertBefore(r,o),i.focus(),i.addEventListener("click",function(){i.parentNode.remove(),"function"==typeof n&&n()})}}function InputNumber(){for(var i=document.querySelectorAll(".input-number"),e=function(e){var t=i[e],n=t.querySelector("span"),o=t.querySelector(".decrement"),r=t.querySelector(".increment");o.addEventListener("click",function(){var e=+t.getAttribute("data-value");(t.getAttribute("data-min")||-1/0)<e&&(e--,n.innerHTML=0==e?"o":e,t.setAttribute("data-value",e)),game.sounds.prev.play}),r.addEventListener("click",function(){var e=+t.getAttribute("data-value");e<(t.getAttribute("data-max")||1/0)&&(e++,n.innerHTML=0==e?"o":e,t.setAttribute("data-value",e)),game.sounds.next.play})},t=i.length-1;0<=t;t--)e(t)}function SnakeChooser(e){var a=this,s=e.querySelectorAll(".snake-chooser");this.currentColor=0,this.changeSnakeColor=function(){for(var e=game.colorsInUse,t=s.length-1;0<=t;t--){var n=s[t],o=n.querySelector(".chooser-prev"),r=n.querySelector(".chooser-next"),i=n.querySelector(".snake");o.classList.remove("disabled"),r.classList.remove("disabled"),e.includes(a.currentColor)?i.classList.add("color-in-use"):i.classList.remove("color-in-use"),0==a.currentColor&&o.classList.add("disabled"),a.currentColor==gameProps.snakes.colors.length-1&&r.classList.add("disabled"),i.style.background=gameProps.snakes.colors[a.currentColor]}};for(var t=s.length-1;0<=t;t--){var n=s[t],o=n.querySelector(".chooser-prev"),r=n.querySelector(".chooser-next");o.addEventListener("click",function(e){-1==e.target.className.indexOf("disabled")&&(a.currentColor--,a.changeSnakeColor(),game.sounds.prev.play)}),r.addEventListener("click",function(e){-1==e.target.className.indexOf("disabled")&&(a.currentColor++,a.changeSnakeColor(),game.sounds.next.play)})}}window.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),window.isLumia=/Lumia/i.test(navigator.userAgent),window.isElectron=/Electron/i.test(navigator.userAgent);