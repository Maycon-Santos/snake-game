"use strict";function Engine(e){var t=this,n=e.ctx.canvas,a=[],i=function(){e.ctx.clearRect(0,0,n.width,n.height),function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];for(var r=a.length;r--;){var i;"function"==typeof a[r][e]&&(i=a[r])[e].apply(i,n)}}("draw")};this.run=function(){var o=t,r=performance.now();requestAnimationFrame(function e(t){var n=(t-r)/1e3;if(n=Math.min(1,n),i(),1<=n)return o.run();requestAnimationFrame(e)}.bind(t))},this.add=function(n){a.push(n),n.update=function(e){for(var t in e)n[t]=e[t]}}}function Food(e,t){var n=this;this.id=t,this.type,this.position=[],e.engine.add(this),e.socket.on("foodUpdate-"+t,this.update),this.draw=function(){"playing"==e.status&&n.type&&(e.ctx.fillStyle=n.type.color,e.ctx.beginPath(),e.ctx.arc(n.position[0]*e.tileSize+e.tileSize/2,n.position[1]*e.tileSize+e.tileSize/2,e.tileSize/2,0,2*Math.PI),e.ctx.closePath(),e.ctx.fill())}}function Game(t){var n,o=this;Object.defineProperty(this,"tileSize",{set:function(e){if(!+e)return console.error("Invalid value");n=Math.floor(+e),t.width=this.tileSize*gameProps.tiles[0],t.height=this.tileSize*gameProps.tiles[1]},get:function(){return n}}),Object.defineProperty(this,"ctx",{value:t.getContext("2d"),writable:!1});var r,i=t.parentNode;Object.defineProperty(this,"status",{set:function(e){return i.className=r=e},get:function(){return r}}),Object.defineProperty(this,"colorsInUse",{get:function(){for(var e=[],t=o.playersInTheRoom.length-1;0<=t;t--){var n=o.playersInTheRoom[t];e.push(n.color)}return e}}),this.playersInTheRoom=[],this.id=null,this.players=[],this.foods=[],this.status="toStart",this.engine=new Engine(this),this.interface=new Interface(this),this.socket=io(),this.multiplayerLocalAllow=!1,this.socket.on("teste",function(e){return console.log(e)}),gestureViewer(this),this.engine.run()}Game.prototype.newGame=function(){this.status="playing"},Game.prototype.addPlayers=function(){for(var e=this.playersInTheRoom.length,t=0;t<e;t++){var n=new Snake(this,this.playersInTheRoom[t]);this.players.push(n)}},Game.prototype.addFoods=function(){var e=new Food(this,this.foods.length);this.foods.push(e),this.foods.length<gameProps.foods.qnt&&this.addFoods()},Game.prototype.resizeCanvas=function(){var t=this,o=document.querySelectorAll(".snake-chooser .snake"),e=function(){var n=[window.innerWidth,window.innerHeight],e=[0,0].map(function(e,t){return n[t]/gameProps.tiles[t]});t.tileSize=e[e[0]>e[1]?1:0],function(){for(var e=o.length-1;0<=e;e--)o[e].style.width=t.tileSize+"px",o[e].style.height=t.tileSize+"px"}()};e(),window.addEventListener("resize",e)},Game.prototype.login=function(e,t){var n=this;this.socket.emit("login",{playerNickname:e}),this.socket.on("logged",function(e){gameProps=Object.assign(gameProps,e.gameProps),e.player.idLocal=0,n.multiplayerLocalAllow=e.multiplayerLocal,n.id=e.myID,n.playersInTheRoom.push(e.player),n.playersInTheRoom=Object.assign(n.playersInTheRoom,e.playersInTheRoom),n.resizeCanvas(),n.socketEvents(),"function"==typeof t&&t(e)}),this.socket.on("multiplayer disabled",function(){n.socket.off("login"),n.socket.off("logged"),n.socket.off("multiplayer disabled"),n.interface.dialogBox.alert("Danied","Local multiplayer disabled.")})},Game.prototype.socketEvents=function(){var o=this;this.socket.on("start",function(){o.interface.closeModal(),o.addPlayers(),o.addFoods(),o.newGame()}),this.socket.on("newPlayer",function(e){o.playersInTheRoom.push(e),o.interface.listPlayersInTheRoom()}),this.socket.on("prepare multiplayer",function(e){for(var t=e.length-1;0<=t;t--){var n=e[t];o.playersInTheRoom.push(n)}o.socket.emit("start")}),this.socket.on("playersInTheRoom update",function(e){var t=e.i;delete e.i,o.playersInTheRoom[t]=Object.assign(o.playersInTheRoom[t],e),game.interface.listPlayersInTheRoom()}),this.socket.on("delPlayer",function(e){delete o.playersInTheRoom[e],o.playersInTheRoom=o.playersInTheRoom.filter(Boolean)})};var gameProps={};function gestureViewer(a){var e=document.querySelector("#gestureViewer"),o=document.createElement("canvas"),r=o.getContext("2d");e.appendChild(o);var s={},l=0,c=function(e,t,n,o){r.strokeStyle="#7da278",r.lineCap="round",r.lineWidth=8,r.beginPath(),r.moveTo(e,t),r.lineTo(n,o),r.stroke()};window.addEventListener("touchstart",function(e){if("playing"==a.status)for(var t=e.changedTouches.length-1;0<=t;t--){var n=e.changedTouches[t],o={x:n.pageX,y:n.pageY};s[n.identifier||++l]=o,c(o.x-1,o.y,o.x,o.y)}}),window.addEventListener("touchmove",function(e){if("playing"==a.status)for(var t=e.changedTouches.length-1;0<=t;t--){var n=e.changedTouches[t],o=s[n.identifier||l],r=n.pageX,i=n.pageY;c(o.x,o.y,r,i),o.x=r,o.y=i}}),window.addEventListener("touchend",function(e){if("playing"==a.status){for(var t=e.changedTouches.length-1;0<=t;t--){var n=e.changedTouches[t];delete s[n.identifier||l]}setTimeout(function(){return r.clearRect(0,0,o.width,o.height)},200)}}),document.ontouchmove=function(e){e.preventDefault()};var t=function(){o.width=window.innerWidth,o.height=window.innerHeight};t(),window.addEventListener("resize",t)}function Interface(a){var t=this,n=document.querySelector("#interface"),e=n.querySelector(".modal"),o=n.querySelector("#login form"),r=o.querySelector('[name="player_name"]'),i=document.querySelector("#after-login .submit"),s=n.querySelector("#main-menu"),l=s.querySelector("#single-player"),c=s.querySelector("#multiplayer"),u=n.querySelector("#multiplayer-menu"),d=u.querySelector(".submit"),h=u.querySelector('[name="player_name"]'),f=u.querySelector(".input-number"),p=n.querySelector("#multiplayer-local"),y=n.querySelector("#multiplayer-local-menu"),m=n.querySelectorAll(".connected-players ul");this.dialogBox=new DialogBox(n);var g=new SnakeChooser(n);new InputNumber,this.closeModal=function(){return e.classList.add("closed")},this.open=function(e){return n.className=e},this.listPlayersInTheRoom=function(){for(var e=m.length-1;0<=e;e--){for(var t=m[e],n=a.playersInTheRoom.length,o="",r=0;r<n;r++){var i=a.playersInTheRoom[r];console.log(gameProps.snakes.colors[i.color]),o+='<li>\n                            <span\n                                style="color: '+gameProps.snakes.colors[i.color]+';">\n                                '+i.nickname+'\n                            </span>\n                            <div class="snake"\n                                style="background: '+gameProps.snakes.colors[i.color]+";\n                                width: "+a.tileSize+"px; height: "+a.tileSize+'px;">\n                            </div>\n                        </li>'}t.innerHTML=o}};var v=s.querySelector("#welcome");o.addEventListener("submit",function(e){a.login(r.value,function(e){v.innerHTML="Hi, "+r.value,g.changeSnakeColor(),t.open("after-login")})}),l.addEventListener("click",function(e){a.socket.emit("start")}),i.addEventListener("click",function(){if(a.colorsInUse.includes(g.currentColor))return t.dialogBox.alert("Denied","This color is being used.");a.socket.emit("changeColor",g.currentColor),a.multiplayerLocalAllow?(t.listPlayersInTheRoom(),y.className="multiplayer-local-viewer",t.open("multiplayer-local-menu")):t.open("main-menu")}),c.addEventListener("click",function(){g.currentColor=0,g.changeSnakeColor(),t.open("multiplayer-menu")}),d.addEventListener("click",function(){if(a.colorsInUse.includes(g.currentColor))return t.dialogBox.alert("Denied","This color is being used.");a.socket.emit("prepare multiplayer",{nickname:h.value,color:g.currentColor,nPlayers:f.getAttribute("data-value")})}),p.addEventListener("click",function(){t.open("multiplayer-local-menu"),a.multiplayerLocalAllow=!0,a.socket.emit("multiplayer-local-allow")})}function Snake(t,e){var n=this;this.id=null,this.idLocal=null,this.nickname=null,this.body=[],this.color=0,this.bodyStart=[0,0],this.killed=!1,this.merge(e),0==this.idLocal&&(this.touchArea="all"),1==this.idLocal&&(t.players[0].touchArea="right",this.touchArea="left"),console.log(this),t.engine.add(this),isNaN(this.idLocal)||new SnakeControls(this,t),t.socket.on("snakeUpdate-"+this.id,function(e){return n.update(e)}),this.draw=function(){n.killed||(t.ctx.fillStyle=gameProps.snakes.colors[n.color],n.body.forEach(function(e){t.ctx.fillRect(e[0]*t.tileSize,e[1]*t.tileSize,t.tileSize,t.tileSize)}))}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function SnakeControls(i,t){var n,a=function(e){e&&t.socket.emit("moveTo",{id:i.id,moveTo:e})},e=document.querySelector("#touch-areas"),o={left:e.querySelector("#left"),right:e.querySelector("#right")},r=(n=gameProps.snakes.keyMaps[i.idLocal])?{directions:Object.keys(n),keys:Object.keys(n).map(function(e){return n[e]}),direction:function(e){return this.directions[this.keys.indexOf(e)]}}:void 0;r&&window.addEventListener("keydown",function(e){return a(r.direction(e.key))});var s={},l={},c=gameProps.snakes.sensibilityTouch,u=[["left","right"],["up","down"]],d={0:"portrait-primary",180:"portrait-secondary",90:"landscape-primary","-90":"landscape-secondary"},h=function(){return screen.msOrientation||(screen.orientation||screen.mozOrientation||{}).type||d[window.orientation]},f=h();window.addEventListener("orientationchange",function(){return f=h()});var p=function(e){return[e.changedTouches[0].pageX,e.changedTouches[0].pageY]};if(i.touchArea)for(var y=Object.keys(o),m=function(e){var t=y[e];console.log(o[t]),o[t].addEventListener("touchstart",function(e){return s[t]=p(e)}),o[t].addEventListener("touchmove",function(e){l[t]=p(e),function(n){var e=[[],[]].map(function(e,t){return s[n][t]-l[n][t]});if(isLumia&&("landscape-primary"===f?e[0]=-e[0]:"landscape-secondary"===f&&(e[1]=-e[1]),-1<f.indexOf("landscape")&&e.reverse(),"portrait-secondary"===f&&(e[0]=-e[0],e[1]=-e[1])),n==i.touchArea||"all"==i.touchArea){var t=+(Math.abs(e[0])<Math.abs(e[1])),o=+(e[t]<0),r=u[t][o];Math.abs(e[t])>=c&&(r!=i.direction&&a(r),s[n]=[].concat(_toConsumableArray(l[n])))}}(t)})},g=y.length-1;0<=g;g--)m(g)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function DialogBox(a){this.alert=function(e,t,n){var o=a.querySelector(".modal"),r=document.createElement("div");r.classList.add("dialog-box","alert"),r.innerHTML="<h1>"+e+"</h1>\n                           <p>"+t+"</p>\n                           <button>Ok</button>";var i=r.querySelector("button");a.insertBefore(r,o),i.focus(),i.addEventListener("click",function(){i.parentNode.remove(),"function"==typeof n&&n()})}}function InputNumber(){for(var i=document.querySelectorAll(".input-number"),e=function(e){var t=i[e],n=t.querySelector("span"),o=t.querySelector(".decrement"),r=t.querySelector(".increment");o.addEventListener("click",function(){var e=+t.getAttribute("data-value");(t.getAttribute("data-min")||-1/0)<e&&(e--,n.innerHTML=0==e?"o":e,t.setAttribute("data-value",e))}),r.addEventListener("click",function(){var e=+t.getAttribute("data-value");e<(t.getAttribute("data-max")||1/0)&&(e++,n.innerHTML=0==e?"o":e,t.setAttribute("data-value",e))})},t=i.length-1;0<=t;t--)e(t)}function SnakeChooser(e){var a=this,s=e.querySelectorAll(".snake-chooser");this.currentColor=0,this.changeSnakeColor=function(){for(var e=game.colorsInUse,t=s.length-1;0<=t;t--){var n=s[t],o=n.querySelector(".chooser-prev"),r=n.querySelector(".chooser-next"),i=n.querySelector(".snake");o.classList.remove("disabled"),r.classList.remove("disabled"),e.includes(a.currentColor)?i.classList.add("color-in-use"):i.classList.remove("color-in-use"),0==a.currentColor&&o.classList.add("disabled"),a.currentColor==gameProps.snakes.colors.length-1&&r.classList.add("disabled"),i.style.background=gameProps.snakes.colors[a.currentColor]}};for(var t=s.length-1;0<=t;t--){var n=s[t],o=n.querySelector(".chooser-prev"),r=n.querySelector(".chooser-next");o.addEventListener("click",function(e){-1==e.target.className.indexOf("disabled")&&(a.currentColor--,a.changeSnakeColor())}),r.addEventListener("click",function(e){-1==e.target.className.indexOf("disabled")&&(a.currentColor++,a.changeSnakeColor())})}}window.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),window.isLumia=/Lumia/i.test(navigator.userAgent),window.isElectron=/Electron/i.test(navigator.userAgent),Array.prototype.isEqual=function(e){return JSON.stringify(this)===JSON.stringify(e)},Array.prototype.sumWith=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];t=[this].concat(_toConsumableArray(t)).sort(function(e,t){return t.length-e.length});for(var o=[].concat(_toConsumableArray(t[0])),r=1,i=t.length;r<i;r++)for(var a=t[r],s=0,l=a.length;s<l;s++){var c=a[s];o[s]+=c}return o},Array.prototype.lastItem=function(){return this[this.length-1]},Object.prototype.merge=function(e){for(var t in e)this[t]=e[t]},"serviceWorker"in navigator&&!isElectron&&navigator.serviceWorker.register("serviceWorker.js").then(function(){return console.log("Service worker funcionando")}).catch(function(){return console.log("Erro ao instalar service worker")});
//# sourceMappingURL=snakeGame.js.map
